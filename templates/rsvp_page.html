{% extends "base.html" %}

{% block title %}RSVP - {{ event.title }}{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ event.title }}</h1>
    <div class="event-details">
        <p><strong>Date:</strong> {{ event.date.strftime('%B %d, %Y at %I:%M %p') }}</p>
        <p><strong>Location:</strong> {{ event.location }}</p>
        <p><strong>Description:</strong> {{ event.description }}</p>
    </div>

    <form id="rsvpForm" class="rsvp-form">
        <h2>Welcome, {{ guest.name }}!</h2>
        
        <div class="form-group">
            <label>Will you attend?</label>
            <div class="rsvp-options">
                <button type="button" class="btn btn-success" onclick="selectRSVP('confirmed')">Yes, I'll be there!</button>
                <button type="button" class="btn btn-danger" onclick="submitRSVP('declined')">Sorry, can't make it</button>
            </div>
        </div>

        <div id="additionalOptions" style="display: none;">
            <div class="form-group">
                <label for="plusOne">Bringing guests?</label>
                <input type="number" id="plusOne" name="plusOne" min="0" max="5" value="0">
            </div>

            {% if event.get_custom_fields().get('meal_options') %}
            <div class="form-group">
                <label for="mealChoice">Meal Preference:</label>
                <select id="mealChoice" name="mealChoice">
                    {% for option in event.get_custom_fields()['meal_options'] %}
                    <option value="{{ option }}">{{ option }}</option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            {% if event.get_custom_fields().get('additional_info') %}
            <div class="form-group">
                <label for="additionalNotes">Additional Notes:</label>
                <textarea id="additionalNotes" name="additionalNotes"></textarea>
            </div>
            {% endif %}

            <div class="form-group">
                <button type="button" class="btn btn-primary" onclick="submitRSVP('confirmed')">Submit RSVP</button>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function selectRSVP(status) {
    const additionalOptions = document.getElementById('additionalOptions');
    if (status === 'confirmed') {
        additionalOptions.style.display = 'block';
    } else {
        additionalOptions.style.display = 'none';
    }
}

function submitRSVP(status) {
    let payload;

    if (status === 'confirmed') {
        const responses = {
            meal_choice: document.getElementById('mealChoice')?.value,
            additional_notes: document.getElementById('additionalNotes')?.value
        };
        payload = {
            status: 'confirmed',
            plus_one_count: parseInt(document.getElementById('plusOne').value) || 0,
            responses: responses
        };
    } else {
        payload = {
            status: 'declined',
            plus_one_count: 0,
            responses: {}
        };
    }

    // Show loading state
    const submitButton = event.target;
    const originalText = submitButton.textContent;
    submitButton.textContent = 'Submitting...';
    submitButton.disabled = true;

    fetch(window.location.href, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            const container = document.querySelector('.container');
            container.innerHTML = '<h1>Thank you for your response!</h1><p>Your RSVP has been recorded.</p>';
        } else {
            alert(data.error || 'There was an error submitting your RSVP. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An unexpected error occurred. Please try again. If the problem persists, please contact the event organizer.');
    })
    .finally(() => {
        // Reset button state
        submitButton.textContent = originalText;
        submitButton.disabled = false;
    });
}
</script>
{% endblock %}